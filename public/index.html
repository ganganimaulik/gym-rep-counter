<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Rep Counter</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937"> <!-- bg-gray-800 -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rep Counter">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Screen Wake Lock Fallback for iOS -->
    <script src="https://unpkg.com/nosleep.js/dist/NoSleep.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-number.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .progress-bar-inner {
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-lg p-6 space-y-6">
        <!-- Main Display -->
        <div class="text-center">
            <p id="status-text" class="text-2xl font-medium text-blue-400 mb-2">Press Start</p>
            <p id="current-exercise-display" class="text-xl text-gray-300 h-7"></p>
            <div class="flex justify-center items-end space-x-6">
                <div>
                    <h1 id="rep-display" class="text-8xl font-bold tracking-tight leading-none">0</h1>
                    <p class="text-lg text-gray-400">REP</p>
                </div>
                <div class="pb-2">
                    <h1 id="set-display" class="text-6xl font-bold tracking-tight leading-none">1</h1>
                    <p class="text-lg text-gray-400">SET</p>
                </div>
            </div>
            <p id="phase-display" class="text-xl text-gray-400 mt-2">&nbsp;</p>
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
            <div id="progress-bar" class="bg-blue-500 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
        </div>

        <!-- Main Controls -->
        <div class="grid grid-cols-3 gap-4">
            <button id="start-btn" class="py-3 px-4 bg-green-600 hover:bg-green-700 rounded-lg text-lg font-semibold transition-transform transform active:scale-95 col-span-2">Start</button>
            <button id="pause-btn" class="py-3 px-4 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-lg font-semibold transition-transform transform active:scale-95 hidden">Pause</button>
            <button id="end-set-btn" class="py-3 px-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-lg font-semibold transition-transform transform active:scale-95 hidden">End Set</button>
            <button id="stop-btn" class="py-3 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-lg font-semibold transition-transform transform active:scale-95">Stop</button>
        </div>

        <!-- Number Jump Buttons -->
        <div>
            <h3 class="text-sm font-medium text-gray-400 mb-2 text-center">Jump to Rep</h3>
            <div id="number-buttons" class="grid grid-cols-5 sm:grid-cols-10 gap-2">
                <!-- Number buttons will be generated here -->
            </div>
        </div>

        <!-- Toggles for Settings and Workout Plans -->
        <div class="flex justify-center space-x-6">
            <button id="workout-plans-toggle" class="text-blue-400 hover:text-blue-300">Workout Plans</button>
            <button id="settings-toggle" class="text-blue-400 hover:text-blue-300">Settings</button>
        </div>

        <!-- Workout Plans Panel -->
        <div id="workout-plans-panel" class="hidden space-y-4 pt-4 border-t border-gray-700">
            <div id="day-list-view">
                <h2 class="text-xl font-semibold text-center">Workout Days</h2>
                <div id="day-list" class="space-y-2 mt-4">
                    <!-- Day items will be injected here -->
                </div>
                <div class.="mt-4 flex space-x-2">
                    <input type="text" id="new-day-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" placeholder="New Day Name (e.g., Push)">
                    <button id="add-day-btn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">Add</button>
                </div>
            </div>
            <!-- Exercise view will be added later -->
            <div id="exercise-view" class="hidden space-y-4">
                <button id="back-to-days-btn" class="text-blue-400 hover:text-blue-300">&larr; Back to Days</button>
                <h2 id="exercise-day-name" class="text-xl font-semibold text-center"></h2>
                <div id="exercise-list" class="space-y-2">
                    <!-- Exercise items will be injected here -->
                </div>
                <div class="space-y-2 pt-4 border-t border-gray-600">
                    <h3 class="text-lg font-semibold">Add/Edit Exercise</h3>
                    <input type="hidden" id="exercise-id">
                    <input type="text" id="exercise-name" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Exercise Name">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="exercise-sets" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Sets">
                        <input type="number" id="exercise-reps" class="w-full bg-gray-700 border border-gray-600 rounded-md p-2" placeholder="Reps">
                    </div>
                    <button id="save-exercise-btn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">Save Exercise</button>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="hidden space-y-4 pt-4 border-t border-gray-700">
            <h2 class="text-xl font-semibold text-center">Configuration</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="countdown-seconds" class="block text-sm font-medium text-gray-300">Countdown (s)</label>
                    <input type="number" id="countdown-seconds" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="1">
                </div>
                <div>
                    <label for="rest-seconds" class="block text-sm font-medium text-gray-300">Rest (s)</label>
                    <input type="number" id="rest-seconds" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="0">
                </div>
                <div>
                    <label for="max-reps" class="block text-sm font-medium text-gray-300">Max Reps</label>
                    <input type="number" id="max-reps" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="1">
                </div>
                 <div>
                    <label for="max-sets" class="block text-sm font-medium text-gray-300">Max Sets</label>
                    <input type="number" id="max-sets" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="1">
                </div>
                 <div>
                    <label for="concentric-seconds" class="block text-sm font-medium text-gray-300">Concentric (s)</label>
                    <input type="number" id="concentric-seconds" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="0.1" step="0.1">
                </div>
                <div>
                    <label for="eccentric-seconds" class="block text-sm font-medium text-gray-300">Eccentric (s)</label>
                    <input type="number" id="eccentric-seconds" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-2 text-white focus:ring-blue-500 focus:border-blue-500" min="0.1" step="0.1">
                </div>
                <div class="col-span-2 flex items-center justify-center pt-2">
                    <label for="eccentric-countdown-toggle" class="mr-3 text-sm font-medium text-gray-300">Eccentric Countdown</label>
                    <input type="checkbox" id="eccentric-countdown-toggle" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                </div>
                <div class="col-span-2 pt-2">
                    <label for="volume-slider" class="block text-sm font-medium text-gray-300 mb-1">Volume</label>
                    <div class="flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                        <input type="range" id="volume-slider" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer" min="0" max="1" step="0.05">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        <span id="volume-value" class="text-sm font-medium w-12 text-right text-gray-300">100%</span>
                    </div>
                </div>
            </div>
            <div class="text-center">
                 <button id="save-settings-btn" class="py-2 px-6 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-all duration-200 transform active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const stopBtn = document.getElementById('stop-btn');
            const endSetBtn = document.getElementById('end-set-btn');
            const repDisplay = document.getElementById('rep-display');
            const statusText = document.getElementById('status-text');
            const phaseDisplay = document.getElementById('phase-display');
            const progressBar = document.getElementById('progress-bar');
            const numberButtonsContainer = document.getElementById('number-buttons');
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const setDisplay = document.getElementById('set-display');
            const workoutPlansToggle = document.getElementById('workout-plans-toggle');
            const workoutPlansPanel = document.getElementById('workout-plans-panel');

            // Settings Inputs
            const countdownInput = document.getElementById('countdown-seconds');
            const maxRepsInput = document.getElementById('max-reps');
            const concentricInput = document.getElementById('concentric-seconds');
            const eccentricInput = document.getElementById('eccentric-seconds');
            const eccentricCountdownToggle = document.getElementById('eccentric-countdown-toggle');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeValue = document.getElementById('volume-value');
            const maxSetsInput = document.getElementById('max-sets');
            const restSecondsInput = document.getElementById('rest-seconds');
            
            // State
            let currentRep = 0;
            let currentSet = 1;
            let maxReps = 15;
            let maxSets = 3;
            let countdownSeconds = 5;
            let restSeconds = 60;
            let concentricSeconds = 1;
            let eccentricSeconds = 4;
            let eccentricCountdownEnabled = true;
            let volume = 1.0;
            let isRunning = false;
            let isPaused = false;
            let isResting = false;
            let intervalId = null;
            let countdownIntervalId = null;
            let restIntervalId = null;
            let currentPhaseTime = 0;
            let currentPhase = ''; // 'concentric' or 'eccentric'
            let audioCtx; // For beeps
            let wakeLock = null;
            let noSleep = null; // For iOS fallback
            let femaleVoice = null; // For eccentric countdown voice

            // Workout Plan State
            let workoutDays = [];
            let currentEditingDayId = null;
            let activeWorkout = null; // { dayId, exerciseIndex }
            const synth = window.speechSynthesis;

            const loadVoices = () => {
                const voices = synth.getVoices();
                femaleVoice = voices.find(voice => /female/i.test(voice.name) && /en-US/i.test(voice.lang) && voice.localService);
                if (!femaleVoice) {
                    femaleVoice = voices.find(voice => /female/i.test(voice.name) && /en/i.test(voice.lang));
                }
                if (!femaleVoice) {
                    femaleVoice = voices.find(voice => /zira|samantha|susan|female/i.test(voice.name));
                }
                console.log('Selected female voice:', femaleVoice ? `${femaleVoice.name} (${femaleVoice.lang})` : 'Default voice will be used');
            };

            // --- Core Functions ---

            const requestWakeLock = async () => {
              // Modern Screen Wake Lock API
              if ('wakeLock' in navigator) {
                try {
                  wakeLock = await navigator.wakeLock.request('screen');
                  wakeLock.addEventListener('release', () => {
                    console.log('Screen Wake Lock was released');
                    wakeLock = null;
                  });
                  console.log('Screen Wake Lock is active');
                  return; // Exit if successful
                } catch (err) {
                  console.warn(`Could not acquire screen wake lock, falling back: ${err.name}, ${err.message}`);
                }
              }
        
              // Fallback for iOS and older browsers using NoSleep.js
              try {
                if (!noSleep) {
                  noSleep = new NoSleep();
                }
                // Must be enabled inside a user interaction event
                await noSleep.enable();
                console.log('NoSleep.js is active as a fallback');
              } catch (err) {
                console.error(`NoSleep.js failed to enable: ${err.message}`);
              }
            };

            const releaseWakeLock = async () => {
                if (wakeLock !== null) {
                    try {
                        await wakeLock.release();
                        wakeLock = null;
                        console.log('Screen Wake Lock released');
                    } catch(err) {
                        console.error('WakeLock release failed:', err);
                    }
                }
                if (noSleep && noSleep.isEnabled) {
                    noSleep.disable();
                    console.log('NoSleep.js disabled');
                }
            };


            const initAudio = () => {
                // Audio must be initialized after a user gesture on some browsers
                if (!audioCtx) {
                    try {
                         audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) {
                        console.error("Web Audio API is not supported in this browser");
                    }
                }
            };

            const playBeep = (frequency = 440, duration = 100) => {
                if (!audioCtx) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.01);

                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                oscillator.type = 'sine';

                oscillator.start(audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration / 1000);
                oscillator.stop(audioCtx.currentTime + duration / 1000);
            };

            const speak = (text, rate = 1.0, voice = null) => {
                if (synth.speaking) {
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.volume = volume;
                utterance.rate = rate;
                if (voice) {
                    utterance.voice = voice;
                }
                synth.speak(utterance);
            };

            const updateDisplay = () => {
                repDisplay.textContent = currentRep;
                setDisplay.textContent = currentSet;
                document.querySelectorAll('.btn-number').forEach(btn => {
                    if (parseInt(btn.dataset.rep) === currentRep) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });

                if (currentRep > 0 && isRunning && !isPaused) {
                     const repDuration = concentricSeconds + eccentricSeconds;
                     const progress = (currentPhaseTime / (currentPhase === 'concentric' ? concentricSeconds : eccentricSeconds)) * 100;
                     progressBar.style.width = `${progress}%`;
                     phaseDisplay.textContent = currentPhase.charAt(0).toUpperCase() + currentPhase.slice(1);
                } else {
                    progressBar.style.width = '0%';
                    phaseDisplay.innerHTML = '&nbsp;';
                }
            };
            
            const endSet = () => {
                if (!isRunning) return;
                stopAllIntervals();
                isRunning = false;

                currentSet++;
                if (currentSet > maxSets) {
                    // If in an active workout, move to the next exercise
                    if (activeWorkout) {
                        activeWorkout.exerciseIndex++;
                        const day = workoutDays.find(d => d.id === activeWorkout.dayId);
                        if (day && day.exercises[activeWorkout.exerciseIndex]) {
                            // Start next exercise after a rest period
                            startRestTimer(true); // true indicates it's a rest between exercises
                        } else {
                            // Workout day finished
                            stopWorkout(true); // true indicates workout is fully complete
                            speak("Workout complete. Well done!");
                            statusText.textContent = "Workout Complete!";
                        }
                    } else {
                        // Standalone set finished
                        stopWorkout();
                        speak("Workout finished. Well done!");
                        statusText.textContent = "Workout Finished!";
                    }
                } else {
                    // Start rest for the next set of the same exercise
                    currentRep = 0;
                    startRestTimer(false);
                }
            };

            const startRepCycle = () => {
                clearInterval(intervalId);
                currentRep++;
                if (currentRep > maxReps) {
                    endSet();
                    return;
                }

                updateDisplay();
                speak(currentRep);
                
                // Concentric phase
                currentPhase = 'concentric';
                currentPhaseTime = 0;
                updateDisplay();

                intervalId = setInterval(() => {
                    currentPhaseTime += 0.1;
                    if (currentPhaseTime >= concentricSeconds) {
                        // Switch to Eccentric phase
                        clearInterval(intervalId);
                        currentPhase = 'eccentric';
                        currentPhaseTime = 0;
                        let lastSpokenSecond = -1;
                        updateDisplay();

                        intervalId = setInterval(() => {
                             currentPhaseTime += 0.1;
                             
                             const currentIntegerSecond = Math.floor(currentPhaseTime);
                             if (eccentricCountdownEnabled && currentIntegerSecond > lastSpokenSecond && currentPhaseTime < eccentricSeconds) {
                                 const numberToSpeak = Math.ceil(eccentricSeconds - currentPhaseTime);
                                 if (numberToSpeak > 0) {
                                     synth.cancel(); 
                                     speak(numberToSpeak, 1.5, femaleVoice);
                                 }
                                 lastSpokenSecond = currentIntegerSecond;
                             }

                             if(currentPhaseTime >= eccentricSeconds) {
                                 clearInterval(intervalId);
                                 startRepCycle();
                             }
                             updateDisplay();
                        }, 100);
                    }
                    updateDisplay();
                }, 100);
            };

            const startRestTimer = (isBetweenExercises = false) => {
                stopAllIntervals();
                isResting = true;
                isRunning = false;

                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                endSetBtn.classList.add('hidden');
                startBtn.classList.add('col-span-2');
                
                let restCount = restSeconds;
                const day = isBetweenExercises ? workoutDays.find(d => d.id === activeWorkout.dayId) : null;
                const nextExercise = isBetweenExercises ? day.exercises[activeWorkout.exerciseIndex] : null;

                const updateRestText = () => {
                    if (isBetweenExercises && nextExercise) {
                        statusText.textContent = `Next: ${nextExercise.name} (${restCount}s)`;
                    } else {
                        statusText.textContent = `Rest: ${restCount}s`;
                    }
                };

                if (isBetweenExercises) {
                    currentRep = 0;
                    currentSet = 1;
                }

                updateRestText(); // Set initial text
                speak(isBetweenExercises && nextExercise ? `Next exercise: ${nextExercise.name}. Rest for ${restSeconds} seconds.` : `Set ${currentSet - 1} complete. Rest for ${restSeconds} seconds.`);
                updateDisplay();

                restIntervalId = setInterval(() => {
                    restCount--;
                    updateRestText(); // Update text every second

                    if (restCount <= 3 && restCount > 0) {
                        playBeep(660, 100);
                    }

                    if (restCount <= 0) {
                        clearInterval(restIntervalId);
                        if (isBetweenExercises) {
                            startNextExercise();
                        } else {
                            statusText.textContent = `Press Start for Set ${currentSet}`;
                            speak(`Rest complete. Press start for set ${currentSet}.`);
                            playBeep(880, 200);
                        }
                    }
                }, 1000);
            };

            const runNextSet = () => {
                stopAllIntervals();
                isResting = false;
                isRunning = true;
                isPaused = false;

                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                endSetBtn.classList.remove('hidden');
                startBtn.classList.remove('col-span-2');
                pauseBtn.textContent = 'Pause';
                
                requestWakeLock();
                startCountdown(startRepCycle);
            }

            const startCountdown = (callback) => {
                stopAllIntervals();
                let count = countdownSeconds;
                statusText.textContent = `Get Ready... ${count}`;
                speak(`Get ready. ${count}`);

                countdownIntervalId = setInterval(() => {
                    count--;
                    if (count > 0) {
                        statusText.textContent = `Get Ready... ${count}`;
                        speak(count);
                    } else if (count === 0) {
                         statusText.textContent = "Go!";
                         speak("Go!");
                         playBeep(880, 200);
                    } else {
                        clearInterval(countdownIntervalId);
                        statusText.textContent = "In Progress";
                        callback();
                    }
                }, 1000);
            };
            
            const startWorkout = (startRep = 0) => {
                if (isRunning) return;
                isResting = false;
                stopAllIntervals();

                if (startRep === 0) {
                    currentRep = 0;
                    currentSet = 1;
                } else {
                    currentRep = startRep - 1;
                    currentSet = 1;
                }
                
                isRunning = true;
                isPaused = false;
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                endSetBtn.classList.remove('hidden');
                startBtn.classList.remove('col-span-2');

                pauseBtn.textContent = 'Pause';
                
                requestWakeLock();
                
                startCountdown(() => {
                    startRepCycle();
                });
            };

            const pauseWorkout = () => {
                if (!isRunning) return;

                if (isPaused) { // Resuming
                    isPaused = false;
                    pauseBtn.textContent = 'Pause';
                    endSetBtn.classList.remove('hidden');
                    requestWakeLock();
                    
                    if (currentRep > 0) {
                        currentRep--;
                    }
                    
                    startCountdown(startRepCycle);

                } else { // Pausing
                    isPaused = true;
                    releaseWakeLock();
                    stopAllIntervals();
                    pauseBtn.textContent = 'Resume';
                    endSetBtn.classList.add('hidden');
                    statusText.textContent = 'Paused';
                    speak("Paused");
                }
            };
            
            const stopWorkout = (isCompleted = false) => {
                releaseWakeLock();
                stopAllIntervals();
                isRunning = false;
                isPaused = false;
                isResting = false;
                currentRep = 0;
                currentSet = 1;
                startBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                endSetBtn.classList.add('hidden');
                startBtn.classList.add('col-span-2');

                if (!isCompleted) {
                    statusText.textContent = 'Workout Stopped';
                    speak("Workout stopped.");
                }

                if (activeWorkout) {
                    document.getElementById('current-exercise-display').textContent = '';
                }
                activeWorkout = null;
                updateDisplay();
                synth.cancel();
            };
            
            const jumpToRep = (repNumber) => {
                stopAllIntervals();
                synth.cancel();
                isRunning = true;
                isPaused = false;
                isResting = false;
                currentRep = repNumber - 1;
                if (currentSet < 1) {
                    currentSet = 1;
                }
                startBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                endSetBtn.classList.remove('hidden');
                startBtn.classList.remove('col-span-2');
                pauseBtn.textContent = 'Pause';
                
                requestWakeLock();
                
                startCountdown(() => {
                    startRepCycle();
                });
            }

            const stopAllIntervals = () => {
                clearInterval(intervalId);
                clearInterval(countdownIntervalId);
                clearInterval(restIntervalId);
                intervalId = null;
                countdownIntervalId = null;
                restIntervalId = null;
            }

            // --- Settings ---
            
            const saveSettings = () => {
                const settings = {
                    countdownSeconds: parseInt(countdownInput.value),
                    maxReps: parseInt(maxRepsInput.value),
                    maxSets: parseInt(maxSetsInput.value),
                    restSeconds: parseInt(restSecondsInput.value),
                    concentricSeconds: parseFloat(concentricInput.value),
                    eccentricSeconds: parseFloat(eccentricInput.value),
                    eccentricCountdownEnabled: eccentricCountdownToggle.checked,
                    volume: parseFloat(volumeSlider.value)
                };
                localStorage.setItem('repCounterSettings', JSON.stringify(settings));
                loadSettings();
                generateNumberButtons();

                const originalText = saveSettingsBtn.textContent;
                saveSettingsBtn.textContent = 'Saved!';
                saveSettingsBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveSettingsBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    saveSettingsBtn.textContent = originalText;
                    saveSettingsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    saveSettingsBtn.classList.remove('bg-green-500');
                }, 1500);
            };

            const loadSettings = () => {
                const settings = JSON.parse(localStorage.getItem('repCounterSettings'));
                if (settings) {
                    countdownSeconds = settings.countdownSeconds || 5;
                    maxReps = settings.maxReps || 15;
                    maxSets = settings.maxSets || 3;
                    restSeconds = settings.restSeconds || 60;
                    concentricSeconds = settings.concentricSeconds || 1;
                    eccentricSeconds = settings.eccentricSeconds || 4;
                    eccentricCountdownEnabled = settings.eccentricCountdownEnabled ?? true;
                    volume = settings.volume ?? 1.0;
                }
                
                countdownInput.value = countdownSeconds;
                maxRepsInput.value = maxReps;
                maxSetsInput.value = maxSets;
                restSecondsInput.value = restSeconds;
                concentricInput.value = concentricSeconds;
                eccentricInput.value = eccentricSeconds;
                eccentricCountdownToggle.checked = eccentricCountdownEnabled;
                volumeSlider.value = volume;
                volumeValue.textContent = `${Math.round(volume * 100)}%`;
            };

            const generateNumberButtons = () => {
                numberButtonsContainer.innerHTML = '';
                for (let i = 1; i <= maxReps; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.dataset.rep = i;
                    button.className = 'btn-number p-2 border-2 border-gray-600 rounded-md text-center hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center';
                    button.addEventListener('click', () => {
                        initAudio();
                        jumpToRep(i)
                    });
                    numberButtonsContainer.appendChild(button);
                }
            }

            const handleVisibilityChange = async () => {
              if (wakeLock === null && document.visibilityState === 'visible' && isRunning && !isPaused) {
                console.log('Re-acquiring wake lock on visibility change');
                await requestWakeLock();
              }
            };

            const startNextExercise = () => {
                const day = workoutDays.find(d => d.id === activeWorkout.dayId);
                const exercise = day.exercises[activeWorkout.exerciseIndex];

                if (!exercise) {
                    stopWorkout(true); // Should be handled by endSet, but as a fallback
                    return;
                }

                // Set up for the new exercise
                maxReps = exercise.reps;
                maxSets = exercise.sets;
                maxRepsInput.value = maxReps;
                maxSetsInput.value = maxSets;
                generateNumberButtons();

                currentRep = 0;
                currentSet = 1;

                document.getElementById('current-exercise-display').textContent = exercise.name;

                runNextSet();
            };

            // --- Workout Plan Functions ---

            const saveWorkoutDays = () => {
                localStorage.setItem('workoutDays', JSON.stringify(workoutDays));
            };

            const loadWorkoutDays = () => {
                const savedDays = localStorage.getItem('workoutDays');
                if (savedDays) {
                    workoutDays = JSON.parse(savedDays);
                }
                renderDayList();
            };

            const addDay = () => {
                const newDayNameInput = document.getElementById('new-day-name');
                const dayName = newDayNameInput.value.trim();
                if (dayName && !workoutDays.some(day => day.name === dayName)) {
                    workoutDays.push({ id: Date.now(), name: dayName, exercises: [] });
                    saveWorkoutDays();
                    renderDayList();
                    newDayNameInput.value = '';
                } else if (!dayName) {
                    alert('Please enter a name for the day.');
                } else {
                    alert('A day with this name already exists.');
                }
            };

            const deleteDay = (dayId) => {
                workoutDays = workoutDays.filter(day => day.id !== dayId);
                saveWorkoutDays();
                renderDayList();
            };

            const showExerciseView = (dayId) => {
                currentEditingDayId = dayId;
                const day = workoutDays.find(d => d.id === dayId);
                if (day) {
                    document.getElementById('day-list-view').classList.add('hidden');
                    document.getElementById('exercise-view').classList.remove('hidden');
                    document.getElementById('exercise-day-name').textContent = `${day.name} - Exercises`;
                    renderExerciseList();
                }
            };

            const showDayListView = () => {
                currentEditingDayId = null;
                document.getElementById('day-list-view').classList.remove('hidden');
                document.getElementById('exercise-view').classList.add('hidden');
                renderDayList();
            };

            const saveExercise = () => {
                const day = workoutDays.find(d => d.id === currentEditingDayId);
                if (!day) return;

                const exerciseId = document.getElementById('exercise-id').value;
                const name = document.getElementById('exercise-name').value.trim();
                const sets = parseInt(document.getElementById('exercise-sets').value);
                const reps = parseInt(document.getElementById('exercise-reps').value);

                if (!name || isNaN(sets) || isNaN(reps) || sets <= 0 || reps <= 0) {
                    alert('Please fill in all fields with valid numbers.');
                    return;
                }

                if (exerciseId) { // Editing existing exercise
                    const exercise = day.exercises.find(ex => ex.id == exerciseId);
                    if (exercise) {
                        exercise.name = name;
                        exercise.sets = sets;
                        exercise.reps = reps;
                    }
                } else { // Adding new exercise
                    day.exercises.push({ id: Date.now(), name, sets, reps });
                }

                saveWorkoutDays();
                renderExerciseList();
                // Clear form
                document.getElementById('exercise-id').value = '';
                document.getElementById('exercise-name').value = '';
                document.getElementById('exercise-sets').value = '';
                document.getElementById('exercise-reps').value = '';
            };

            const editExercise = (exerciseId) => {
                const day = workoutDays.find(d => d.id === currentEditingDayId);
                const exercise = day?.exercises.find(ex => ex.id === exerciseId);
                if (exercise) {
                    document.getElementById('exercise-id').value = exercise.id;
                    document.getElementById('exercise-name').value = exercise.name;
                    document.getElementById('exercise-sets').value = exercise.sets;
                    document.getElementById('exercise-reps').value = exercise.reps;
                }
            };

            const deleteExercise = (exerciseId) => {
                const day = workoutDays.find(d => d.id === currentEditingDayId);
                if (day) {
                    day.exercises = day.exercises.filter(ex => ex.id !== exerciseId);
                    saveWorkoutDays();
                    renderExerciseList();
                }
            };

            const renderExerciseList = () => {
                const day = workoutDays.find(d => d.id === currentEditingDayId);
                const exerciseListContainer = document.getElementById('exercise-list');
                exerciseListContainer.innerHTML = '';

                if (!day || day.exercises.length === 0) {
                    exerciseListContainer.innerHTML = `<p class="text-center text-gray-500">No exercises added yet.</p>`;
                    return;
                }

                day.exercises.forEach(ex => {
                    const exElement = document.createElement('div');
                    exElement.className = 'flex items-center justify-between bg-gray-600 p-3 rounded-lg';
                    exElement.innerHTML = `
                        <div>
                            <span class="font-medium">${ex.name}</span>
                            <span class="text-sm text-gray-400 ml-2">${ex.sets} sets x ${ex.reps} reps</span>
                        </div>
                        <div class="space-x-2">
                            <button class="edit-exercise-btn text-yellow-400 hover:text-yellow-300" data-exercise-id="${ex.id}">Edit</button>
                            <button class="delete-exercise-btn text-red-500 hover:text-red-400" data-exercise-id="${ex.id}">Delete</button>
                        </div>
                    `;
                    exerciseListContainer.appendChild(exElement);
                });

                // Attach event listeners
                document.querySelectorAll('.edit-exercise-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const exerciseId = parseInt(e.target.getAttribute('data-exercise-id'));
                        editExercise(exerciseId);
                    });
                });

                document.querySelectorAll('.delete-exercise-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const exerciseId = parseInt(e.target.getAttribute('data-exercise-id'));
                        if (confirm('Are you sure you want to delete this exercise?')) {
                            deleteExercise(exerciseId);
                        }
                    });
                });
            };

            const renderDayList = () => {
                const dayListContainer = document.getElementById('day-list');
                dayListContainer.innerHTML = '';
                if (workoutDays.length === 0) {
                    dayListContainer.innerHTML = `<p class="text-center text-gray-500">No workout days created yet.</p>`;
                    return;
                }

                workoutDays.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    dayElement.innerHTML = `
                        <span class="font-medium">${day.name}</span>
                        <div class="space-x-2">
                            <button class="start-day-btn text-green-400 hover:text-green-300" data-day-id="${day.id}">Start</button>
                            <button class="edit-day-btn text-yellow-400 hover:text-yellow-300" data-day-id="${day.id}">Edit</button>
                            <button class="delete-day-btn text-red-500 hover:text-red-400" data-day-id="${day.id}">Delete</button>
                        </div>
                    `;
                    dayListContainer.appendChild(dayElement);
                });

                // Attach event listeners
                document.querySelectorAll('.delete-day-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const dayId = parseInt(e.target.getAttribute('data-day-id'));
                        if (confirm('Are you sure you want to delete this day and all its exercises?')) {
                            deleteDay(dayId);
                        }
                    });
                });

                document.querySelectorAll('.edit-day-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const dayId = parseInt(e.target.getAttribute('data-day-id'));
                        showExerciseView(dayId);
                    });
                });

                document.querySelectorAll('.start-day-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const dayId = parseInt(e.target.getAttribute('data-day-id'));
                        const day = workoutDays.find(d => d.id === dayId);
                        if (day && day.exercises.length > 0) {
                            activeWorkout = { dayId: dayId, exerciseIndex: 0 };
                            workoutPlansPanel.classList.add('hidden');
                            startNextExercise();
                        } else {
                            alert('This day has no exercises. Please add some first.');
                        }
                    });
                });
            };


            // --- Event Listeners ---
            startBtn.addEventListener('click', () => {
                initAudio();
                if (isResting) {
                    runNextSet();
                } else {
                    startWorkout();
                }
            });
            pauseBtn.addEventListener('click', pauseWorkout);
            stopBtn.addEventListener('click', stopWorkout);
            endSetBtn.addEventListener('click', endSet);
            settingsToggle.addEventListener('click', () => {
                settingsPanel.classList.toggle('hidden');
                workoutPlansPanel.classList.add('hidden'); // Hide other panel
            });

            workoutPlansToggle.addEventListener('click', () => {
                workoutPlansPanel.classList.toggle('hidden');
                settingsPanel.classList.add('hidden'); // Hide other panel
                renderDayList(); // Re-render when opening
            });

            document.getElementById('add-day-btn').addEventListener('click', addDay);
            document.getElementById('back-to-days-btn').addEventListener('click', showDayListView);
            document.getElementById('save-exercise-btn').addEventListener('click', saveExercise);

            saveSettingsBtn.addEventListener('click', saveSettings);

            volumeSlider.addEventListener('input', () => {
                volume = parseFloat(volumeSlider.value);
                volumeValue.textContent = `${Math.round(volume * 100)}%`;
            });
            
            volumeSlider.addEventListener('change', () => {
                initAudio();
                playBeep(660, 50);
            });

            document.addEventListener('visibilitychange', handleVisibilityChange);

            // --- Initialisation ---
            loadSettings();
            generateNumberButtons();
            updateDisplay();
            loadWorkoutDays();

            loadVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = loadVoices;
            }

            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(reg => {
                        console.log('Service Worker registered.', reg);
                    }).catch(err => {
                        console.log('Service Worker registration failed: ', err);
                    });
                });
            }
        });
    </script>

</body>
</html>

